Inspection and Negotiation Flow (Seller ↔ Buyer)

1) Initiation
- A buyer selects property/properties (max 2 tracked in GlobalPropertyActionsContext: selectedForInspection[]).
- Buyer can request inspection or initiate negotiation from marketplace/property pages.
- Booking may require payment; on success the API often returns a transaction authorization_url to redirect the buyer (e.g., new-marketplace DateTimeSelection, ShortletBookingModal).

2) Secure response links
- Each inspection/negotiation is accessed through secure links per role:
  • Buyer: /secure-buyer-response/[userId]/[inspectionId]
  • Seller: /secure-seller-response/[userId]/[inspectionId]
- Access is validated: GET {BASE}/inspections/validate-access/:userId/:inspectionId

3) Loading inspection details
- GET {BASE}/inspections/inspection-details/:userId/:inspectionId/:userType returns:
  • inspectionType: "price" or "LOI"
  • stage: "negotiation" | "inspection" | "completed" | "cancelled"
  • pendingResponseFrom: "buyer" | "seller" | "admin"
  • letterOfIntention (for LOI), negotiationPrice, sellerCounterOffer, counterCount
  • inspectionDate, inspectionTime, inspectionMode ("in_person" | "virtual"), property, etc.
- 48h expiry window is computed from updatedAt. If elapsed > 48h → expired until reopened.

4) Turn-based workflow
- Only the party indicated by pendingResponseFrom may act; the other sees an Awaiting Response screen with a countdown.
- Admin review state is shown when pendingResponseFrom == "admin".
- Reopen (legacy/backward compat): PUT {BASE}/inspections/:inspectionId/reOpen with { userType }.

5) Actions (single unified endpoint)
- POST {BASE}/inspections/:inspectionId/actions/:userId with payload:
  Base: { userType: "buyer"|"seller", action: "accept"|"reject"|"counter", inspectionType: "price"|"LOI", [inspectionDate], [inspectionTime], [inspectionMode] }
  For price counter: include counterPrice (number).
  For reject: include rejectionReason (string).
- After successful action the system refetches details and updates stage/pendingResponseFrom.

6) Price negotiation step (inspectionType == "price")
- Current offer the user sees:
  • Seller sees buyer's offer (negotiationPrice) or original property price.
  • Buyer sees sellerCounterOffer if present, otherwise their negotiationPrice.
- Responses available:
  • Accept → proceeds to schedule step to confirm/select inspection date/time.
  • Counter → enter counterPrice, min rules:
    - Buyer must offer ≥ 80% of original property price.
    - Cannot exceed original property price.
    - Max 3 counters total (counterCount < 3).
    - On continue, proceeds to schedule step; counter is submitted together with schedule.
  • Reject → optional rejectionReason, proceeds to schedule step and submits rejection with schedule.
- Counters capped at 3; UI communicates remaining counters.

7) LOI negotiation step (inspectionType == "LOI")
- Buyer uploads/submits a Letter of Intention (text rendered/previewed, downloadable). 
- Seller responses only:
  • Accept → proceeds to schedule step to confirm/select inspection date/time.
  • Reject → optional rejectionReason, proceeds to schedule step and submits rejection with schedule.
- Buyers may be asked to reupload/update LOI if seller requested changes (tracked via counterCount with a 3-change limit shown in UI).

8) Schedule (InspectionDateTimeStep)
- Always follows the negotiation action. Both parties confirm/update date/time/mode before submitting their response.
- Date generation rules:
  • Start from tomorrow; Sundays excluded.
  • Show 10 dates by default with “View more”; includes current inspection date if valid.
- Time slots: hourly 08:00–18:00; for same-day selection, past slots are disabled with a 1-hour buffer.
- Modes: "in_person" or "virtual".
- Two flows:
  • Confirm Schedule → createAcceptPayload/submitNegotiationAction.
  • Update Schedule → createCounterPayload (or createAccept/Reject with new schedule), then submit.
- If current inspectionDate/time has passed, UI warns or disables confirm.

9) Stages and completion
- stage transitions:
  • negotiation → inspection (after responses and schedule confirmation)
  • inspection → completed (post-inspection workflows, not detailed here)
  • Any point → cancelled (renders cancellation summary)
- Summary pages:
  • EnhancedNegotiationSummary for completed.
  • EnhancedNegotiationCancelledSummary for cancelled.

10) State and persistence
- GlobalPropertyActionsContext persists selectedForInspection[], negotiatedPrices[], and clears related state when removing properties from inspection.
- Notifications and unread counts are fetched for logged-in users to surface updates.

Key Components/Modules
- Context: src/context/secure-negotiations-context.tsx (API calls, payload builders, turn/expiry logic)
- Flow: src/components/secure-negotiations/flow/* (price, LOI, schedule, awaiting)
- Pages: src/components/secure-negotiations/{buyer-response,seller-response}
- Types: src/types/secure-negotiation.ts, src/types/negotiation.ts
- Booking/Payment examples: new-marketplace/DateTimeSelection, ShortletBookingModal

Notes
- All actions are turn-based via pendingResponseFrom; only the indicated party can act.
- 48h timeout per turn; expired negotiations require reopen.
- Validation and UX guardrails (min buyer offer, counter limits, Sunday exclusion, time windows) are enforced in the UI prior to submission.
