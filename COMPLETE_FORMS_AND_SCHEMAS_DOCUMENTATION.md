# Complete Forms, MongoDB Schemas, and Auto-Population Guide

## Table of Contents
1. [Overview](#overview)
2. [Schema Alignment & Auto-Population](#schema-alignment--auto-population)
3. [Preference Form Fields & MongoDB Schema](#preference-form-fields--mongodb-schema)
4. [Property Listing Form Fields & MongoDB Schema](#property-listing-form-fields--mongodb-schema)
5. [Form-to-Schema Mapping](#form-to-schema-mapping)
6. [Auto-Population Logic](#auto-population-logic)
7. [Database Indexes](#database-indexes)
8. [API Integration](#api-integration)

---

## Overview

This document provides:
1. **Complete field documentation** for all preference and property forms
2. **MongoDB schema definitions** in TypeScript with Mongoose
3. **Mapping guide** showing how form fields map to database schemas
4. **Auto-population logic** for creating properties from preferences

### Key Design Principles

- **Schema Alignment**: Preference and Property schemas share similar structures for seamless data transfer
- **Type Consistency**: Both schemas use matching field names and data types
- **Preference Reference**: Properties track their source preference via `sourcePreferenceId`
- **Location Inheritance**: Location fields match between schemas for filtering and matching
- **Budget Mapping**: Budget fields align for threshold validation

---

## Schema Alignment & Auto-Population

### Core Concept

When a user submits a preference, a property can be auto-generated by:

1. Creating a new Property document
2. Copying relevant fields from the Preference document
3. Setting `sourcePreferenceId` to track the origin
4. Storing `preferenceType` for context
5. Adding listing-specific fields (images, contact info, owner info)

### Data Flow Diagram

```
Preference Form Submission
        ↓
  Validate Preference Data
        ↓
  Create Preference Document
        ↓
  Auto-Generate Property Document
        ├─ Copy: location, budget, features
        ├─ Copy: propertyDetails / developmentDetails / bookingDetails
        ├─ Map: contactInfo → contactInfo & owner
        ├─ Set: sourcePreferenceId, preferenceType
        └─ Initialize: images[], documents[], status='draft'
        ↓
  Property Ready for Publishing
```

---

## Preference Form Fields & MongoDB Schema

### Buy Preference Form

#### Frontend Form Structure

**Step 1: Location & Area**
```typescript
location: {
  state: string;              // "Lagos"
  lgas: string[];             // ["Ikoyi", "Victoria Island"]
  areas?: string[];           // ["Ikoyi", "Banana Island"]
  customLocation?: string;    // If area not found
}
```

**Step 2: Property Details & Budget**
```typescript
propertyDetails: {
  propertySubtype: "land" | "residential" | "commercial";
  buildingType?: "detached" | "semi-detached" | "block-of-flats";
  minBedrooms?: number | "More";
  minBathrooms?: number;
  propertyCondition?: "new" | "renovated" | "old";
  purpose?: "for-living" | "resale" | "development";
  measurementUnit?: "plot" | "sqm" | "hectares";
  landSize?: number;
  documentTypes?: string[];
}

budget: {
  minPrice: number;           // 250000000
  maxPrice: number;           // 500000000
  currency: "NGN";
}

nearbyLandmark?: string;
```

**Step 3: Features & Amenities**
```typescript
features: {
  basicFeatures: string[];    // ["Gym House", "Security Cameras"]
  premiumFeatures: string[]; // ["Elevator", "Swimming Pool"]
  autoAdjustToBudget: boolean;
}
```

**Step 4: Contact Information**
```typescript
contactInfo: {
  fullName: string;
  email: string;
  phoneNumber: string;
}

additionalNotes?: string;
```

#### MongoDB Schema (PreferenceSchema.ts)

```typescript
interface IPreference extends Document {
  userId: string;
  preferenceType: 'buy';
  preferenceMode: 'buy';
  location: ILocation;
  budget: IBudgetRange;
  features: IFeatureSelection;
  contactInfo: IContactInfo;
  propertyDetails: IBuyPropertyDetails;
  nearbyLandmark?: string;
  additionalNotes?: string;
  status: 'active' | 'paused' | 'fulfilled' | 'expired';
  matchedPropertiesCount: number;
  autoGeneratedProperties?: string[];
  createdAt: Date;
  updatedAt: Date;
}
```

#### Schema Details

**Location Schema**
```typescript
{
  state: { type: String, required: true, index: true },
  lgas: { type: [String], required: true, min: 1, max: 3 },
  areas: { type: [String], max: 3 },
  customLocation: { type: String, maxlength: 200 }
}
```

**Budget Schema**
```typescript
{
  minPrice: { type: Number, required: true, min: 0 },
  maxPrice: { type: Number, required: true, validate: maxPrice > minPrice },
  currency: { type: String, default: 'NGN', enum: ['NGN', 'USD', 'GBP'] }
}
```

**Buy Property Details Schema**
```typescript
{
  propertySubtype: { type: String, enum: ['land', 'residential', 'commercial'], required: true },
  buildingType: { type: String, enum: ['detached', 'semi-detached', 'block-of-flats'] },
  minBedrooms: { type: Mixed, validate: 'More' || (1-10) },
  minBathrooms: { type: Number },
  propertyCondition: { type: String, enum: ['new', 'renovated', 'old'] },
  purpose: { type: String, enum: ['for-living', 'resale', 'development'] },
  measurementUnit: { type: String, enum: ['plot', 'sqm', 'hectares'] },
  landSize: { type: Number },
  documentTypes: { type: [String], default: [] }
}
```

**Indexes**
```typescript
PreferenceSchema.index({ userId: 1, preferenceType: 1 });
PreferenceSchema.index({ 'location.state': 1, preferenceType: 1 });
PreferenceSchema.index({ status: 1, expiresAt: 1 });
PreferenceSchema.index({ createdAt: -1 });
```

---

### Rent Preference Form

#### Frontend Form Structure

**Step 1: Location & Area**
Same as Buy

**Step 2: Property Details & Budget**
```typescript
propertyDetails: {
  propertySubtype: "self-con" | "flat" | "mini-flat" | "bungalow";
  minBedrooms?: number | "More";
  minBathrooms?: number;
  leaseTerm: "6-months" | "1-year";
  propertyCondition: "new" | "renovated";
  purpose: "residential" | "office";
}

budget: {
  minPrice: number;           // 500000
  maxPrice: number;           // 1200000
  currency: "NGN";
}
```

**Step 3: Features & Amenities**
Same structure as Buy

**Step 4: Contact Information**
Same structure as Buy

#### MongoDB Schema

```typescript
interface IRentPropertyDetails {
  propertySubtype: 'self-con' | 'flat' | 'mini-flat' | 'bungalow';
  minBedrooms?: number | 'More';
  minBathrooms?: number;
  leaseTerm?: '6-months' | '1-year';
  propertyCondition?: 'new' | 'renovated';
  purpose?: 'residential' | 'office';
}
```

**Rent Property Details Schema**
```typescript
{
  propertySubtype: { type: String, enum: ['self-con', 'flat', 'mini-flat', 'bungalow'], required: true },
  minBedrooms: { type: Mixed, validate: 'More' || (1-10) },
  minBathrooms: { type: Number },
  leaseTerm: { type: String, enum: ['6-months', '1-year'] },
  propertyCondition: { type: String, enum: ['new', 'renovated', 'good-condition'] },
  purpose: { type: String, enum: ['residential', 'office'] }
}
```

---

### Joint Venture Preference Form

#### Frontend Form Structure

**Step 1: Developer Information**
```typescript
contactInfo: {
  companyName: string;
  contactPerson: string;
  email: string;
  phoneNumber: string;
  cacRegistrationNumber?: string;
}
```

**Step 2: Development Type**
```typescript
developmentDetails: {
  developmentTypes: string[];  // ["Mini Flats", "Luxury Duplexes"]
}
```

**Step 3: Land Requirements**
```typescript
location: {
  state: string;
  lgas: string[];
  areas?: string[];
  customLocation?: string;
}

developmentDetails: {
  minLandSize: string;        // "50"
  measurementUnit: "plot" | "sqm" | "hectares";
  propertyType?: "land" | "old-building" | "structure-to-demolish";
  landConditions?: string[];
}

budget: {
  minPrice: number;           // 500000000
  maxPrice: number;           // 2000000000
  currency: "NGN";
}
```

**Step 4: JV Terms & Proposal**
```typescript
developmentDetails: {
  jvType: "equity-split" | "lease-to-build" | "development-partner";
  preferredSharingRatio: string;  // "60-40"
  timeline: "ready-now" | "in-3-months" | "within-1-year";
}

partnerExpectations?: string;
```

**Step 5: Title & Documentation**
```typescript
developmentDetails: {
  minimumTitleRequirements: string[];  // ["Certificate of Occupancy", "Survey Document"]
}
```

#### MongoDB Schema

```typescript
interface IDevelopmentDetails {
  minLandSize: string;
  measurementUnit: 'plot' | 'sqm' | 'hectares';
  propertyType?: 'land' | 'old-building' | 'structure-to-demolish';
  expectedStructureType?: string;
  jvType?: 'equity-split' | 'lease-to-build' | 'development-partner';
  timeline?: 'ready-now' | 'in-3-months' | 'within-1-year';
  budgetRange?: number;
  landConditions?: string[];
  preferredSharingRatio?: string;
  minimumTitleRequirements?: string[];
  developmentTypes?: string[];
}
```

---

### Shortlet Preference Form

#### Frontend Form Structure

**Step 1: Location & Area**
Same as Buy

**Step 2: Property Details & Booking**
```typescript
bookingDetails: {
  propertyType: "studio" | "1-bed" | "2-bed";
  minBedrooms: number | "More";
  numberOfGuests: number;
  checkInDate: string;        // "2024-03-15"
  checkOutDate: string;       // "2024-03-22"
}

budget: {
  minPrice: number;           // 50000 (per night)
  maxPrice: number;           // 150000
  currency: "NGN";
}
```

**Step 3: Features & Amenities**
Same structure with comfort features

**Step 4: Contact Information**
Same structure as Buy

#### MongoDB Schema

```typescript
interface IBookingDetails {
  propertyType?: 'studio' | '1-bed' | '2-bed';
  minBedrooms?: number | 'More';
  numberOfGuests?: number;
  checkInDate?: string;
  checkOutDate?: string;
}
```

---

## Property Listing Form Fields & MongoDB Schema

### Buy Property Listing Form

#### Frontend Form Structure

**Step 1: Basic Details**
```typescript
{
  title: string;                  // "Luxury 4-Bedroom Detached House in Ikoyi"
  description: string;            // Detailed description
  propertySubtype: "land" | "residential" | "commercial";
  propertyCondition: "new" | "renovated" | "old";
}
```

**Step 2: Property Details**
```typescript
{
  buildingType?: string;          // For residential
  bedrooms?: number;
  bathrooms?: number;
  toilets?: number;
  parkingSpaces?: number;
  landSize?: string;
  measurementUnit?: "plot" | "sqm" | "hectares";
  buildingSize?: string;
  furnished?: boolean;
  serviced?: boolean;
}
```

**Step 3: Location**
```typescript
{
  state: string;                  // "Lagos"
  lga: string;                    // "Ikoyi"
  area: string;                   // "Ikoyi"
  detailedAddress?: string;       // "12 Banana Island Road, Ikoyi"
}
```

**Step 4: Pricing**
```typescript
{
  price: number;                  // 350000000
  currency: "NGN";
  negotiable: boolean;            // true
  paymentPlans?: string[];        // ["Full Payment", "Installment"]
}
```

**Step 5: Features & Amenities**
```typescript
{
  securityFeatures?: string[];    // ["CCTV", "Electric Fencing"]
  amenities?: string[];           // ["Gym", "Swimming Pool"]
  keyFeatures?: string[];         // ["Elevator", "Staff Room"]
}
```

**Step 6: Documents**
```typescript
{
  documentTypes?: string[];       // ["Certificate of Occupancy", "Survey"]
}
```

**Step 7: Images**
```typescript
{
  images: File[];                 // Min 1 image
}
```

**Step 8: Contact Information**
```typescript
{
  contactInfo: {
    name: string;
    email: string;
    phone: string;
    whatsapp?: string;
    preferredContactMethod: "email" | "phone" | "whatsapp";
    contactTimes?: string[];
  }
}
```

**Step 9: Ownership Declaration**
```typescript
{
  ownershipDeclaration: {
    isOwner: boolean;
    hasRightToSell: boolean;
    noLegalDisputes: boolean;
    accurateInformation: boolean;
  }
}
```

#### MongoDB Schema (PropertySchema.ts)

```typescript
interface IProperty extends Document {
  title: string;
  description: string;
  category: 'sale' | 'rent' | 'shortlet' | 'joint-venture';
  status: 'draft' | 'pending-verification' | 'active' | 'sold' | 'rented' | 'suspended';
  location: IPropertyLocation;
  price: IPropertyPrice;
  features: IPropertyFeatures;
  amenities: IPropertyAmenities;
  propertyDetails: IBuyPropertyDetails;
  images: IPropertyImage[];
  documents: IPropertyDocument[];
  contactInfo: IPropertyContactInfo;
  owner: IPropertyOwnerInfo;
  agent?: IPropertyOwnerInfo;
  ownershipDeclaration: IOwnershipDeclaration;
  sourcePreferenceId?: string;
  preferenceType?: 'buy';
  verified: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

#### Schema Details

**Location Schema**
```typescript
{
  state: { type: String, required: true, index: true },
  lga: { type: String, required: true, index: true },
  area: { type: String },
  detailedAddress: { type: String, maxlength: 500 },
  coordinates: {
    latitude: Number,
    longitude: Number
  }
}
```

**Price Schema**
```typescript
{
  amount: { type: Number, required: true, min: 0 },
  currency: { type: String, default: 'NGN', enum: ['NGN', 'USD', 'GBP'] },
  negotiable: { type: Boolean, default: false },
  paymentPlans: { type: [String], default: [] },
  weeklyRate: { type: Number },
  monthlyRate: { type: Number }
}
```

**Features Schema**
```typescript
{
  bedrooms: { type: Number },
  bathrooms: { type: Number },
  toilets: { type: Number },
  parkingSpaces: { type: Number },
  landSize: { type: String },
  measurementUnit: { type: String, enum: ['plot', 'sqm', 'hectares'] },
  buildingSize: { type: String },
  furnished: { type: Boolean },
  serviced: { type: Boolean },
  maxGuests: { type: Number }
}
```

**Amenities Schema**
```typescript
{
  securityFeatures: { type: [String], default: [] },
  amenities: { type: [String], default: [] },
  keyFeatures: { type: [String], default: [] }
}
```

**Contact Info Schema**
```typescript
{
  name: { type: String, required: true, maxlength: 100 },
  email: { type: String, required: true, match: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
  phone: { type: String, required: true },
  whatsapp: { type: String },
  preferredContactMethod: { type: String, enum: ['email', 'phone', 'whatsapp'], required: true },
  contactTimes: { type: [String], default: [] }
}
```

**Owner Info Schema**
```typescript
{
  id: { type: String },
  name: { type: String, required: true },
  email: { type: String, required: true },
  phone: { type: String, required: true },
  verified: { type: Boolean, default: false },
  agentType: { type: String, enum: ['individual', 'agent', 'agency'] },
  cacRegistrationNumber: { type: String }
}
```

**Ownership Declaration Schema**
```typescript
{
  isOwner: { type: Boolean, required: true },
  hasRightToSell: { type: Boolean, required: true },
  noLegalDisputes: { type: Boolean, required: true },
  accurateInformation: { type: Boolean, required: true }
}
```

**Indexes**
```typescript
PropertySchema.index({ category: 1, status: 1 });
PropertySchema.index({ 'location.state': 1, category: 1 });
PropertySchema.index({ 'location.lga': 1, 'location.state': 1 });
PropertySchema.index({ verified: 1, status: 1 });
PropertySchema.index({ featured: 1, status: 1, createdAt: -1 });
PropertySchema.index({ 'price.amount': 1, category: 1 });
PropertySchema.index({ sourcePreferenceId: 1 });
PropertySchema.index({ createdAt: -1 });
PropertySchema.index({ title: 'text', description: 'text' });
```

---

### Rent Property Listing Form

#### Frontend Form Structure

**Step 1: Basic Details**
```typescript
{
  title: string;
  description: string;
  propertySubtype: "self-con" | "flat" | "mini-flat" | "bungalow";
  propertyCondition: "new" | "good-condition" | "renovation";
}
```

**Step 2: Property Details**
```typescript
{
  bedrooms: number;              // Required
  bathrooms: number;             // Required
  toilets?: number;
  parkingSpaces?: number;
  furnished?: boolean;
  serviced?: boolean;
  employmentType?: string;       // e.g., "Employed", "Self-employed"
}
```

**Steps 3-8:** Same as Buy (Location, Pricing, Contact, Ownership)

#### MongoDB Schema

```typescript
interface IRentPropertyDetails {
  propertySubtype: 'self-con' | 'flat' | 'mini-flat' | 'bungalow';
  propertyCondition?: 'new' | 'good-condition' | 'renovation';
  purpose?: 'residential' | 'office';
  employmentType?: string;
  documentTypes?: string[];
}
```

---

### Shortlet Property Listing Form

#### Frontend Form Structure

**Step 1: Basic Details**
```typescript
{
  title: string;
  description: string;
  propertySubtype: "studio" | "1-bed" | "2-bed" | "3-bed";
  propertyCondition: "new" | "renovated" | "good-condition";
}
```

**Step 2: Property Details**
```typescript
{
  bedrooms: number;
  bathrooms: number;             // Required, min 1
  parkingSpaces?: number;
  furnished: boolean;            // Usually true
  serviced: boolean;             // Usually true
  maxGuests: number;             // Required
  travelType?: string;
}
```

**Step 3: Location** (Same as Buy)

**Step 4: Pricing**
```typescript
{
  price: number;                 // Per night
  currency: "NGN";
  negotiable?: boolean;
  weeklyRate?: number;           // Discounted weekly
  monthlyRate?: number;          // Discounted monthly
}
```

**Step 5: Features & Amenities** (With comfort features)

**Step 6: House Rules**
```typescript
{
  checkInTime?: string;          // "3:00 PM"
  checkOutTime?: string;         // "10:00 AM"
  minimumStayDays?: number;      // e.g., 2
  cancellationPolicy?: string;
  housePolicies?: string[];      // Rules array
}
```

**Steps 7-9:** Images, Contact, Ownership (same structure)

#### MongoDB Schema

```typescript
interface IShortletPropertyDetails {
  propertySubtype: 'studio' | '1-bed' | '2-bed' | '3-bed';
  propertyCondition?: 'new' | 'renovated' | 'good-condition';
  checkInTime?: string;
  checkOutTime?: string;
  minimumStayDays?: number;
  cancellationPolicy?: string;
  housePolicies?: string[];
}
```

---

### Joint Venture Property Listing Form

#### Frontend Form Structure

**Step 1: Basic Details**
```typescript
{
  title: string;
  description: string;
  propertySubtype: "land" | "old-building" | "structure-to-demolish";
  propertyCondition?: "new" | "renovated" | "uncompleted";
}
```

**Step 2: Property Details**
```typescript
{
  landSize: string;              // Required for land
  measurementUnit: "plot" | "sqm" | "hectares";
  bedrooms?: number;             // For buildings
  bathrooms?: number;
  buildingSize?: string;
}
```

**Steps 3-9:** Same pattern (Location, Pricing, Documents, Images, Contact, Ownership)

#### MongoDB Schema

```typescript
interface IJointVenturePropertyDetails {
  propertySubtype: 'land' | 'old-building' | 'structure-to-demolish';
  developmentTypes?: string[];
  landConditions?: string[];
  jvType?: 'equity-split' | 'lease-to-build' | 'development-partner';
  preferredSharingRatio?: string;
  timeline?: 'ready-now' | 'in-3-months' | 'within-1-year';
  minimumTitleRequirements?: string[];
}
```

---

## Form-to-Schema Mapping

### Buy Preference → Buy Property

| Preference Field | Property Field | Notes |
|------------------|---|---|
| `location` | `location` | Direct mapping |
| `budget` | `price` | minPrice/maxPrice → amount range check |
| `features` | `amenities` | Convert to amenities arrays |
| `propertyDetails` | `propertyDetails` | Direct mapping |
| `contactInfo` | `contactInfo` + `owner` | Split between contact and owner |
| `nearbyLandmark` | `amenities.keyFeatures` | Optional addition |
| `userId` | `owner.id` | Track original submitter |
| N/A | `sourcePreferenceId` | Set to Preference ID |
| N/A | `preferenceType` | Set to "buy" |
| N/A | `images[]` | Empty array, user adds images |
| N/A | `documents[]` | Empty array, user uploads |
| N/A | `status` | Set to "draft" initially |

### Rent Preference → Rent Property

| Preference Field | Property Field | Notes |
|------------------|---|---|
| `location` | `location` | Direct mapping |
| `budget` | `price` | Monthly rent amount |
| `features` | `amenities` | Convert to amenities |
| `propertyDetails` | `propertyDetails` | Direct mapping |
| `contactInfo` | `contactInfo` + `owner` | Split mapping |
| N/A | `employmentType` | From form if available |
| N/A | `sourcePreferenceId` | Set to Preference ID |
| N/A | `preferenceType` | Set to "rent" |

### Joint Venture Preference → JV Property

| Preference Field | Property Field | Notes |
|------------------|---|---|
| `location` | `location` | Direct mapping |
| `budget` | `price` | Investment/value amount |
| `developmentDetails` | `propertyDetails` | Mapped fields |
| `contactInfo` | `owner` | Company info as owner |
| N/A | `sourcePreferenceId` | Set to Preference ID |
| N/A | `preferenceType` | Set to "joint-venture" |

### Shortlet Preference → Shortlet Property

| Preference Field | Property Field | Notes |
|------------------|---|---|
| `location` | `location` | Direct mapping |
| `budget` | `price` | Per-night rates |
| `bookingDetails` | `propertyDetails` + `features` | Split mapping |
| `features` | `amenities` | Convert to amenities |
| `contactInfo` | `contactInfo` + `owner` | Split mapping |
| N/A | `sourcePreferenceId` | Set to Preference ID |
| N/A | `preferenceType` | Set to "shortlet" |

---

## Auto-Population Logic

### Implementation Example

```typescript
/**
 * Auto-populate a property from a preference submission
 * Called after preference validation and creation
 */
async function autoPopulatePropertyFromPreference(
  preference: IPreference,
  currentUserId: string
): Promise<string> {
  try {
    // Prepare base property data from preference
    const propertyData: Partial<IProperty> = {
      title: generatePropertyTitle(preference),
      description: generatePropertyDescription(preference),
      category: mapPreferenceTypeToCategory(preference.preferenceType),
      status: 'draft', // Start as draft
      location: {
        state: preference.location.state,
        lga: preference.location.lgas[0], // Use first LGA
        area: preference.location.areas?.[0] || '',
        customLocation: preference.location.customLocation,
      },
      price: {
        amount: preference.budget.minPrice,
        currency: preference.budget.currency,
        negotiable: true,
      },
      features: mapPreferenceDetailsToFeatures(preference),
      amenities: {
        keyFeatures: preference.location.areas || [],
      },
      propertyDetails: preference.propertyDetails,
      contactInfo: {
        name: preference.contactInfo.fullName || preference.contactInfo.contactPerson || '',
        email: preference.contactInfo.email,
        phone: preference.contactInfo.phoneNumber,
        preferredContactMethod: 'email',
      },
      owner: {
        id: currentUserId,
        name: preference.contactInfo.fullName || preference.contactInfo.contactPerson || '',
        email: preference.contactInfo.email,
        phone: preference.contactInfo.phoneNumber,
        verified: false,
      },
      ownershipDeclaration: {
        isOwner: true,
        hasRightToSell: true,
        noLegalDisputes: true,
        accurateInformation: true,
      },
      sourcePreferenceId: preference._id.toString(),
      preferenceType: preference.preferenceType,
      images: [],
      documents: [],
    };

    // Create property
    const property = new Property(propertyData);
    const savedProperty = await property.save();

    // Update preference to track auto-generated property
    await Preference.findByIdAndUpdate(
      preference._id,
      {
        $push: { autoGeneratedProperties: savedProperty._id.toString() },
      }
    );

    return savedProperty._id.toString();
  } catch (error) {
    console.error('Error auto-populating property:', error);
    throw error;
  }
}

/**
 * Helper functions for auto-population
 */

function generatePropertyTitle(preference: IPreference): string {
  const bedrooms = preference.propertyDetails?.minBedrooms || 'Multi';
  const area = preference.location.areas?.[0] || preference.location.state;
  const type = preference.preferenceType === 'shortlet' ? 'Shortlet' : 'Property';
  
  return `${bedrooms}-Bedroom ${type} in ${area}`;
}

function generatePropertyDescription(preference: IPreference): string {
  let desc = `Listed based on preference: ${preference.preferenceType}. `;
  
  if (preference.additionalNotes) {
    desc += preference.additionalNotes;
  }
  if (preference.nearbyLandmark) {
    desc += ` Near ${preference.nearbyLandmark}.`;
  }
  
  return desc;
}

function mapPreferenceTypeToCategory(type: string): string {
  const mapping: Record<string, string> = {
    'buy': 'sale',
    'rent': 'rent',
    'shortlet': 'shortlet',
    'joint-venture': 'joint-venture',
  };
  return mapping[type] || 'sale';
}

function mapPreferenceDetailsToFeatures(preference: IPreference): IPropertyFeatures {
  const details = preference.propertyDetails;
  
  return {
    bedrooms: details?.minBedrooms === 'More' ? undefined : details?.minBedrooms,
    bathrooms: details?.minBathrooms,
    landSize: details?.landSize?.toString(),
    measurementUnit: details?.measurementUnit,
  };
}
```

### Auto-Population Workflow

1. **Preference Submission**
   - User submits preference form
   - Validation passes
   - Preference document created in MongoDB

2. **Trigger Auto-Population**
   - After preference save, call `autoPopulatePropertyFromPreference()`
   - Extract relevant fields
   - Create minimal Property document with status='draft'

3. **User Enhancement**
   - User can now edit auto-generated property
   - Add images, documents, refine details
   - Update pricing, amenities, etc.

4. **Publishing**
   - User submits for verification
   - Status changes to 'pending-verification'
   - Admin reviews and approves
   - Status changes to 'active'

---

## Database Indexes

### Preference Indexes

```typescript
// Compound indexes for common queries
PreferenceSchema.index({ userId: 1, preferenceType: 1 });
PreferenceSchema.index({ 'location.state': 1, preferenceType: 1 });
PreferenceSchema.index({ status: 1, expiresAt: 1 });
PreferenceSchema.index({ createdAt: -1 });

// Single field indexes
db.preferences.createIndex({ userId: 1 });
db.preferences.createIndex({ status: 1 });
db.preferences.createIndex({ "location.state": 1 });
```

### Property Indexes

```typescript
// Compound indexes for common queries
PropertySchema.index({ category: 1, status: 1 });
PropertySchema.index({ 'location.state': 1, category: 1 });
PropertySchema.index({ 'location.lga': 1, 'location.state': 1 });
PropertySchema.index({ verified: 1, status: 1 });
PropertySchema.index({ featured: 1, status: 1, createdAt: -1 });
PropertySchema.index({ 'price.amount': 1, category: 1 });
PropertySchema.index({ sourcePreferenceId: 1 });
PropertySchema.index({ createdAt: -1 });
PropertySchema.index({ title: 'text', description: 'text' }); // Text search

// Single field indexes
db.properties.createIndex({ category: 1 });
db.properties.createIndex({ status: 1 });
db.properties.createIndex({ verified: 1 });
db.properties.createIndex({ featured: 1 });
db.properties.createIndex({ userId: 1 });
```

---

## API Integration

### Preference Submission Endpoint

```typescript
/**
 * POST /api/preferences
 * Create a new preference and auto-generate property
 */
POST /api/preferences
Content-Type: application/json

{
  "preferenceType": "buy",
  "preferenceMode": "buy",
  "location": {
    "state": "Lagos",
    "lgas": ["Ikoyi", "VI"],
    "areas": ["Ikoyi"]
  },
  "propertyDetails": {
    "propertySubtype": "residential",
    "buildingType": "detached",
    "minBedrooms": 4,
    "propertyCondition": "new",
    "purpose": "for-living"
  },
  "budget": {
    "minPrice": 250000000,
    "maxPrice": 500000000,
    "currency": "NGN"
  },
  "features": {
    "basicFeatures": ["Gym House", "Security Cameras"],
    "premiumFeatures": ["Swimming Pool"],
    "autoAdjustToBudget": false
  },
  "contactInfo": {
    "fullName": "Adebayo Akanji",
    "email": "adebayo@example.com",
    "phoneNumber": "+2348012345678"
  },
  "additionalNotes": "Need property close to good schools"
}

Response (201 Created):
{
  "success": true,
  "message": "Preference submitted successfully",
  "data": {
    "preferenceId": "pref_1234567890",
    "autoGeneratedPropertyId": "prop_1234567890",
    "status": "active",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### Property Listing Endpoint

```typescript
/**
 * POST /api/properties
 * Create a new property listing (can be from preference or standalone)
 */
POST /api/properties
Content-Type: multipart/form-data

FormData:
- title: "Luxury 4-Bedroom Detached House in Ikoyi"
- description: "..."
- category: "sale"
- location[state]: "Lagos"
- location[lga]: "Ikoyi"
- location[area]: "Ikoyi"
- location[detailedAddress]: "12 Banana Island Road"
- price[amount]: 350000000
- price[currency]: "NGN"
- features[bedrooms]: 4
- features[bathrooms]: 3
- amenities[securityFeatures]: ["CCTV", "Electric Fencing"]
- amenities[amenities]: ["Gym", "Swimming Pool"]
- propertyDetails[propertySubtype]: "residential"
- propertyDetails[buildingType]: "detached"
- contactInfo[name]: "Adebayo Akanji"
- contactInfo[email]: "adebayo@example.com"
- contactInfo[phone]: "+2348012345678"
- ownershipDeclaration[isOwner]: true
- ownershipDeclaration[hasRightToSell]: true
- ownershipDeclaration[noLegalDisputes]: true
- ownershipDeclaration[accurateInformation]: true
- sourcePreferenceId: "pref_1234567890" (optional, for auto-populated)
- images: [File1, File2, File3...]

Response (201 Created):
{
  "success": true,
  "message": "Property created successfully",
  "data": {
    "propertyId": "prop_1234567890",
    "status": "pending-verification",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### Get Property with Matched Preferences

```typescript
/**
 * GET /api/properties/:id/matches
 * Get a property with its matched preferences
 */
GET /api/properties/prop_1234567890/matches

Response:
{
  "success": true,
  "data": {
    "property": {
      "_id": "prop_1234567890",
      "title": "Luxury 4-Bedroom Detached House",
      "category": "sale",
      "location": { "state": "Lagos", ... },
      "price": { "amount": 350000000, ... },
      "sourcePreferenceId": "pref_1234567890"
    },
    "sourcePreference": {
      "_id": "pref_1234567890",
      "preferenceType": "buy",
      "budget": { "minPrice": 250000000, ... }
    },
    "matchedPreferences": [
      { _id: "pref_...", userId: "user_..." },
      { _id: "pref_...", userId: "user_..." }
    ],
    "matchScore": 0.95
  }
}
```

---

## Validation Rules Summary

### Preference Validation

| Field | Type | Required | Min | Max | Pattern |
|-------|------|----------|-----|-----|---------|
| location.state | String | ✓ | - | - | - |
| location.lgas | Array | ✓ | 1 | 3 | - |
| location.areas | Array | - | - | 3 | - |
| budget.minPrice | Number | ✓ | 0 | - | - |
| budget.maxPrice | Number | ✓ | >minPrice | - | - |
| contactInfo.email | String | ✓ | - | 255 | `^[^\s@]+@[^\s@]+\.[^\s@]+$` |
| contactInfo.phoneNumber | String | ✓ | - | - | Nigerian format |

### Property Validation

| Field | Type | Required | Min | Max | Pattern |
|-------|------|----------|-----|-----|---------|
| title | String | ✓ | - | 250 | - |
| description | String | ✓ | - | 5000 | - |
| category | String | ✓ | - | - | sale\|rent\|shortlet\|joint-venture |
| location.state | String | ✓ | - | - | - |
| location.lga | String | ✓ | - | - | - |
| price.amount | Number | ✓ | 0 | - | - |
| images | Array | ✓ | 1 | 20 | - |
| contactInfo.email | String | ✓ | - | 255 | `^[^\s@]+@[^\s@]+\.[^\s@]+$` |

---

## Database Connection & Initialization

### Connection Setup

```typescript
// config/database.ts
import mongoose from 'mongoose';

export async function connectDatabase() {
  try {
    await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/khabiteq');
    console.log('✓ Database connected');
  } catch (error) {
    console.error('✗ Database connection failed:', error);
    process.exit(1);
  }
}

export async function disconnectDatabase() {
  await mongoose.disconnect();
  console.log('✓ Database disconnected');
}
```

### Schema Import & Usage

```typescript
// In your API route handlers
import Preference from '@/DB/mongodb/schemas/PreferenceSchema';
import Property from '@/DB/mongodb/schemas/PropertySchema';

// Create a preference
const preference = new Preference(preferenceData);
await preference.save();

// Auto-populate property
const property = new Property({
  ...propertyData,
  sourcePreferenceId: preference._id,
});
await property.save();

// Query with indexes
const activePreferences = await Preference.find({
  status: 'active',
  'location.state': 'Lagos',
}).sort({ createdAt: -1 });

const featuredProperties = await Property.find({
  category: 'sale',
  featured: true,
  status: 'active',
}).sort({ createdAt: -1 }).limit(10);
```

---

## Environment Variables

```env
# MongoDB
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/khabiteq

# API Configuration
NEXT_PUBLIC_API_URL=https://khabiteq-realty.onrender.com/api

# Google OAuth
NEXT_PUBLIC_GOOGLE_CLIENT_ID=your_client_id

# Facebook
NEXT_PUBLIC_FACEBOOK_APP_ID=your_app_id
```

---

## Summary

### Files Created

1. **DB/mongodb/schemas/PreferenceSchema.ts** (465 lines)
   - Complete Mongoose schema for preferences
   - Supports Buy, Rent, Joint Venture, Shortlet
   - Includes all field validations and indexes

2. **DB/mongodb/schemas/PropertySchema.ts** (637 lines)
   - Complete Mongoose schema for properties
   - Aligned with PreferenceSchema for auto-population
   - Includes tracking of source preference
   - Comprehensive indexes for performance

3. **PROPERTY_FORMS_DOCUMENTATION.md**
   - Original form field documentation

4. **COMPLETE_FORMS_AND_SCHEMAS_DOCUMENTATION.md** (This file)
   - Complete integration guide
   - Form-to-schema mapping
   - Auto-population logic with examples
   - API endpoint specifications

### Key Features

✅ **Complete Field Coverage** - All form fields documented  
✅ **Schema Alignment** - Preference and Property schemas share structure  
✅ **Auto-Population Ready** - Properties can be generated from preferences  
✅ **Optimized Indexes** - Performance indexes on common query patterns  
✅ **Validation Rules** - All field constraints and formats specified  
✅ **Type Safety** - Full TypeScript interfaces for all schemas  
✅ **Extensible Design** - Easy to add new property types or features

---

**Last Updated:** January 2024  
**Version:** 1.0  
**Status:** Production Ready
